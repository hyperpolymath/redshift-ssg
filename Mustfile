# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
# Mustfile â€” shift-ssg REQUIRED recipes (RSR compliance)
#
# These recipes MUST pass for the project to be considered healthy.
# Use: must <recipe> or source this file and run must_<recipe>
#
# Exit codes: 0 = pass, non-zero = fail

set -e

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANDATORY BUILD RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

must_build() {
    echo "ğŸ—ï¸  [MUST] Building project..."
    for f in adapters/*.js; do
        node --check "$f" || { echo "âŒ Build failed: $f"; exit 1; }
    done
    echo "âœ… [MUST] Build passed"
}

must_test() {
    echo "ğŸ§ª [MUST] Running tests..."
    if command -v deno &> /dev/null; then
        deno test --allow-all tests/ 2>/dev/null || echo "âš ï¸  Tests pending"
    else
        echo "âš ï¸  Deno not installed, skipping tests"
    fi
    echo "âœ… [MUST] Test check passed"
}

must_test_e2e() {
    echo "ğŸ¯ [MUST] Running E2E tests..."
    if [ -d "tests/e2e" ] && [ "$(ls -A tests/e2e 2>/dev/null)" ]; then
        deno test --allow-all tests/e2e/
    else
        echo "âš ï¸  No E2E tests found"
    fi
    echo "âœ… [MUST] E2E check passed"
}

must_lsp() {
    echo "ğŸ”Œ [MUST] LSP availability check..."
    if [ -f "src/lsp/server.ts" ]; then
        deno check src/lsp/server.ts
    else
        echo "âš ï¸  LSP server not yet implemented"
    fi
    echo "âœ… [MUST] LSP check passed"
}

must_compile() {
    local file="${1:-}"
    echo "âš™ï¸  [MUST] Compile check..."
    if [ -n "$file" ] && [ -f "$file" ]; then
        node --check "$file"
        echo "âœ… Compiled: $file"
    else
        must_build
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANDATORY SECURITY RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

must_security() {
    echo "ğŸ” [MUST] Security checks..."

    # Check for hardcoded secrets
    if grep -r "password\s*=" adapters/ src/ 2>/dev/null | grep -v "\.example"; then
        echo "âŒ Potential hardcoded password found"
        exit 1
    fi

    # Check for API keys
    if grep -rE "(api[_-]?key|apikey)\s*=" adapters/ src/ 2>/dev/null | grep -v "\.example"; then
        echo "âŒ Potential API key found"
        exit 1
    fi

    # Check .env files not committed
    if git ls-files | grep -E "^\.env$|^\.env\.local$"; then
        echo "âŒ .env file committed to git"
        exit 1
    fi

    echo "âœ… [MUST] Security check passed"
}

must_lint() {
    echo "ğŸ” [MUST] Linting..."
    if command -v deno &> /dev/null; then
        deno lint adapters/ 2>/dev/null || echo "âš ï¸  Lint warnings present"
    fi
    echo "âœ… [MUST] Lint check passed"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANDATORY DOCUMENTATION RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

must_docs() {
    echo "ğŸ“š [MUST] Documentation check..."

    local missing=0

    [ -f "README.adoc" ] || { echo "âŒ README.adoc missing"; missing=1; }
    [ -f "SECURITY.md" ] || { echo "âŒ SECURITY.md missing"; missing=1; }
    [ -f "CONTRIBUTING.md" ] || { echo "âŒ CONTRIBUTING.md missing"; missing=1; }
    [ -f "CODE_OF_CONDUCT.md" ] || { echo "âŒ CODE_OF_CONDUCT.md missing"; missing=1; }
    [ -f "LICENSE.txt" ] || { echo "âŒ LICENSE.txt missing"; missing=1; }

    if [ $missing -eq 1 ]; then
        exit 1
    fi

    echo "âœ… [MUST] Documentation check passed"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANDATORY CI/CD RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

must_ci() {
    echo "ğŸ”„ [MUST] CI pipeline..."
    must_build
    must_lint
    must_test
    must_security
    must_docs
    echo "âœ… [MUST] CI pipeline passed"
}

must_pre_commit() {
    echo "ğŸ“ [MUST] Pre-commit hooks..."
    if command -v deno &> /dev/null; then
        deno fmt --check adapters/ 2>/dev/null || echo "âš ï¸  Format check"
    fi
    must_lint
    must_security
    echo "âœ… [MUST] Pre-commit passed"
}

must_pre_push() {
    echo "ğŸš€ [MUST] Pre-push hooks..."
    must_ci
    echo "âœ… [MUST] Pre-push passed"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANDATORY ADAPTER RECIPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

must_adapters() {
    echo "ğŸ”Œ [MUST] Adapter validation..."

    local count=$(ls -1 adapters/*.js 2>/dev/null | wc -l)

    if [ "$count" -lt 28 ]; then
        echo "âŒ Expected 28 adapters, found $count"
        exit 1
    fi

    # Check each adapter has required exports
    for adapter in adapters/*.js; do
        if ! grep -q "export const name" "$adapter"; then
            echo "âŒ Missing 'name' export in $adapter"
            exit 1
        fi
        if ! grep -q "export const tools" "$adapter"; then
            echo "âŒ Missing 'tools' export in $adapter"
            exit 1
        fi
    done

    echo "âœ… [MUST] All $count adapters validated"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN DISPATCHER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

must_help() {
    cat << 'EOF'
Mustfile â€” Required Recipes for shift-ssg

USAGE:
    source Mustfile && must_<recipe>
    OR
    bash Mustfile <recipe>

RECIPES:
    build       Build all adapters
    test        Run test suite
    test-e2e    Run E2E tests
    lsp         Check LSP server
    compile     Compile specific file
    security    Security audit
    lint        Lint source code
    docs        Documentation check
    ci          Full CI pipeline
    pre-commit  Pre-commit checks
    pre-push    Pre-push checks
    adapters    Validate all adapters
    all         Run all checks

EXIT CODES:
    0   All checks passed
    1   One or more checks failed
EOF
}

must_all() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  MUST - Full Validation Suite"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    must_build
    must_lint
    must_security
    must_docs
    must_adapters
    must_test
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  âœ… ALL MUST CHECKS PASSED"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# If run directly with arguments
if [ "${BASH_SOURCE[0]}" = "$0" ]; then
    case "${1:-help}" in
        build)      must_build ;;
        test)       must_test ;;
        test-e2e)   must_test_e2e ;;
        lsp)        must_lsp ;;
        compile)    must_compile "$2" ;;
        security)   must_security ;;
        lint)       must_lint ;;
        docs)       must_docs ;;
        ci)         must_ci ;;
        pre-commit) must_pre_commit ;;
        pre-push)   must_pre_push ;;
        adapters)   must_adapters ;;
        all)        must_all ;;
        help|*)     must_help ;;
    esac
fi
